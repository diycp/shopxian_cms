<?php 

/**
 * 秀仙系统 shopxian_release/3.0.0
 * ============================================================================
 * * 版权所有 2017-2018 上海秀仙网络科技有限公司，并保留所有权利。
 * 网站地址: http://www.shopxian.com；
 * ----------------------------------------------------------------------------
 * 本软件只能免费使用  不允许对程序代码以任何形式任何目的再发布或者出售。
 * ============================================================================
 * 作者: 张启全 

 * 时间: 2018-03-15 19:07:21
 */   namespace lib\base;  use \think\Controller;  use think\facade\Request;  use think\Loader;    class BaseController extends Controller{      protected $user_id='';      protected $uname='';      protected $time_start;      protected $shop_id=0;      protected $site_type='site';      protected $app_path;              function __construct($login=true) {          $this->time_start=microtime(true);          parent::__construct();          $this->user_id= session("user_id");          $this->uname= session("uname");          if($login){                              safety();             if($this->user_id==false){                  if(request()->isAjax()){                      return ['status'=>false,'msg'=>'请先登陆','url'=>url('desktop/AdminPassport/login','',true,true)];                  }else{                      exit($this->redirect(url('desktop/AdminPassport/login','',true,true).'?url='. request()->domain().$_SERVER['REQUEST_URI']));                  }              }else{                  if(session('role_id')>0){                      $permission_menus=cache('permission_menus'.$this->user_id);                      $a=strtolower(request()->module());                      $c=strtolower(request()->controller());                      $ac=strtolower(request()->action());                                           if($permission_menus&&!in_array($a.'_'.$c.'_'.$ac, $permission_menus)){                                                   if(!in_array($a.'_'.$c, $permission_menus)){                              exit("您没有权限");                          }else if(!in_array(strtolower($ac), $permission_menus)){                              exit("您没有权限");                          }                      }                  }              }              $this->assign('user_id', $this->user_id);          }          $this->app_path= shopXianEnv('app_path');          if(defined('SITE_TYPE')){              $this->site_type=SITE_TYPE;          }else{              if(request()->isMobile())$this->site_type='wap';          }      }                  protected function showTpl($tpl_name='',$data=[]){          $view_suffix='.'. config('template.view_suffix');          if($tpl_name=='')$tpl_name=request()->action();          $tpl= $this->app_path.strtolower(request()->module().DIRECTORY_SEPARATOR.'view'.DIRECTORY_SEPARATOR.$this->site_type.DIRECTORY_SEPARATOR.Loader::parseName(request()->controller()).DIRECTORY_SEPARATOR.$tpl_name.$view_suffix);          return $this->fetch($tpl,$data);      }      public function display($content = '', $vars = array(), $replace = array(), $config = array()) {          return parent::display($content, $vars, $replace, $config);      }              public function statusMsg($status='',$msg='',$url='',$close=true){          if($status)return $this->success($msg,$url,$close);          return $this->error($msg, $url);      }      public function status_msg($status='',$msg='',$url=''){          $this->assign('status', $status);          $this->assign('msg', $msg);          return $this->fetch(shopXianEnv('extend_path').'view/base/'.$this->site_type.'/status_msg.html');      }      function __destruct() {          if(config('conf.runtime_show')==1){              $time_end = microtime(true);              $total=$time_end-$this->time_start;              echo "此php文件中代码执行了{$total}秒";          }      }      public function _empty($name='')      {          $info='';          if($name)$info='方法不存在:'.request()->module().'\\'.request()->controller().'\\'.request()->action();          return view(shopXianEnv('extend_path').'view/base/site/_empty.html',['icon'=>'&#xe61c;','title'=>'404 Not Found','info'=>$info],404);      }  }  