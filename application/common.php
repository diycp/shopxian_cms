<?php       use lib\base\AppLog;  use lib\base\AppConfig;  if (!function_exists('appModel')) {      function appModel($app,$model){          return model("model\\$app\\$model");      }  }    if (!function_exists('token_encode')) {      function token_encode($string = '', $skey = '') {          if($skey==false)$skey= config ('app.token_key');          $strArr = str_split(base64_encode($string));          $strCount = count($strArr);          foreach (str_split($skey) as $key => $value)              $key < $strCount && $strArr[$key].=$value;          return str_replace(array('=', '+', '/'), array('O0O0O', 'o000o', 'oo00o'), join('', $strArr));      }  }    if (!function_exists('token_decode')) {      function token_decode($string = '', $skey = '') {          if($skey==false)$skey= config ('app.token_key');          $strArr = str_split(str_replace(array('O0O0O', 'o000o', 'oo00o'), array('=', '+', '/'), $string), 2);          $strCount = count($strArr);          foreach (str_split($skey) as $key => $value)              $key <= $strCount  && isset($strArr[$key]) && $strArr[$key][1] === $value && $strArr[$key] = $strArr[$key][0];          return base64_decode(join('', $strArr));      }  }  if (!function_exists('rpcCall')) {      function rpcCall($app,$api) {          $obj='app\\'.$app.'\api\\'.$api;          return new $obj();      }  }  if (!function_exists('apiUrl')) {      function apiUrl($app,$controller,$method,$vars=[]) {          $pathinfo_depr= config('pathinfo_depr');          $vars_str='';          if($vars){              foreach ($vars as $key => $value) {                  $vars_str.=$pathinfo_depr.$key.$pathinfo_depr.$value;              }          }          return root_path().'/api'.$pathinfo_depr.$app.$pathinfo_depr.$controller.$pathinfo_depr.$method.$vars_str;      }  }  if (!function_exists('requestData')) {      function requestData() {          $request_data='';          if(isset($_SERVER["HTTP_USER_AGENT"]))$request_data.='浏览器信息:'.$_SERVER["HTTP_USER_AGENT"].',';          if($_REQUEST)$request_data.='请求参数:'.json_encode($_REQUEST, JSON_UNESCAPED_UNICODE).',';          if($input= file_get_contents('php:/'.'/input'))$request_data.=",输入流:".$input.',';          if($session=session(''))$request_data.=",session:".json_encode($session,JSON_UNESCAPED_UNICODE).',';          return $request_data;      }  }  if (!function_exists('AppLog')) {      function AppLog($url,$request_data,$response_data, $type = INFO,$request_type='get',$run_time=0,$request_route='') {          return AppLog::write($url,$request_data,$response_data, $type,$request_type,$run_time,$request_route);      }  }  if (!function_exists('appConfig')) {      function appConfig($name = '',$app = '', $value = null)      {          if (is_null($value) && is_string($name)) {              return AppConfig::get($name,$app);          }else if(is_null($value) && is_array($name)){              return AppConfig::all($name,$app);          } else {              return Config::set($name,$app,$value);          }      }  }  if (!function_exists('importExecl')) {      function importExecl($file='', $sheet=0)      {          $file = iconv("utf-8", "gb2312", $file);            if(empty($file) OR !file_exists($file)) {                die('file not exists!');            }                      include(shopXianEnv('extend_path').DIRECTORY_SEPARATOR.'lib'.DIRECTORY_SEPARATOR.'base'.DIRECTORY_SEPARATOR.'PHPExcel.php');           $objRead = new PHPExcel_Reader_Excel2007();            if(!$objRead->canRead($file)){                $objRead = new PHPExcel_Reader_Excel5();                if(!$objRead->canRead($file)){                    die('No Excel!');                }            }              $cellName = array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'AA', 'AB', 'AC', 'AD', 'AE', 'AF', 'AG', 'AH', 'AI', 'AJ', 'AK', 'AL', 'AM', 'AN', 'AO', 'AP', 'AQ', 'AR', 'AS', 'AT', 'AU', 'AV', 'AW', 'AX', 'AY', 'AZ');              $obj = $objRead->load($file);           $currSheet = $obj->getSheet($sheet);            $columnH = $currSheet->getHighestColumn();            $columnCnt = array_search($columnH, $cellName);            $rowCnt = $currSheet->getHighestRow();              $data = array();            for($_row=1; $_row<=$rowCnt; $_row++){               for($_column=0; $_column<=$columnCnt; $_column++){                    $cellId = $cellName[$_column].$_row;                    $cellValue = $currSheet->getCell($cellId)->getValue();                                      if($cellValue instanceof PHPExcel_RichText){                        $cellValue = $cellValue->__toString();                    }                      $data[$_row][$cellName[$_column]] = $cellValue;                }            }              return $data;      }  }    if (!function_exists('exportExcel')) {      function exportExcel($table_name='表名',$title=array(), $data=array(), $fileName='', $savePath='./', $isDown=false)      {          include(shopXianEnv('extend_path').DIRECTORY_SEPARATOR.'lib'.DIRECTORY_SEPARATOR.'base'.DIRECTORY_SEPARATOR.'PHPExcel.php');           $obj = new PHPExcel();                       $cellName = array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'AA', 'AB', 'AC', 'AD', 'AE', 'AF', 'AG', 'AH', 'AI', 'AJ', 'AK', 'AL', 'AM', 'AN', 'AO', 'AP', 'AQ', 'AR', 'AS', 'AT', 'AU', 'AV', 'AW', 'AX', 'AY', 'AZ');              $obj->getActiveSheet(0)->setTitle($table_name);            $_row = 1;            if($title){                $_cnt = count($title);                $obj->getActiveSheet(0)->mergeCells('A'.$_row.':'.$cellName[$_cnt-1].$_row);                $obj->setActiveSheetIndex(0)->setCellValue('A'.$_row, $table_name.'   导出时间:'.date('Y-m-d H:i:s'));               $obj->getActiveSheet()->getStyle('A'.$_row)->getFont()->setBold(true);              $obj->getActiveSheet()->getStyle('A'.$_row)->getFont()->setSize(14);              $obj -> getActiveSheet() -> getColumnDimension() -> setAutoSize(true);              $obj->getActiveSheet()->freezePaneByColumnAndRow(0,3);             $_row++;                $i = 0;                foreach($title AS $v){                    $obj->setActiveSheetIndex(0)->setCellValue($cellName[$i].$_row, $v);                    $obj->getActiveSheet()->getStyle($cellName[$i].'2')->getFont()->setBold(true);                 $obj->getActiveSheet()->getStyle($cellName[$i].'2')->getFont()->setSize(14);                  $i++;                }                $_row++;            }                     if($data){                $i = 0;                foreach($data AS $_v){                    $j = 0;                    foreach($_v AS $_cell){                        $obj->getActiveSheet(0)->setCellValue($cellName[$j] . ($i+$_row), $_cell);                        $obj->getActiveSheet()->getStyle($cellName[$j].($i+$_row))->getAlignment()->setWrapText(true);                      $width=20;                      if($_cell){                          $width=(int)mb_strlen($_cell)*2.3;                          if(is_numeric($_cell)&&($my_width=mb_strlen($_cell))>20){                              $width=$my_width;                          }                      }                      if($width<20)$width=20;                      $obj->getActiveSheet()->getColumnDimension($cellName[$j])->setWidth($width);                     $j++;                    }                    $i++;                }            }                     if(!$fileName){                $fileName = uniqid(time(),true);            }              $objWrite = PHPExcel_IOFactory::createWriter($obj, 'Excel2007');              if($isDown){                header('pragma:public');                header("Content-Disposition:attachment;filename=$fileName.xls");                $objWrite->save('php:'.'/'.'/output');exit;            }              $_fileName = iconv("utf-8", "gb2312", $fileName);            $_savePath = $savePath.$_fileName.'.xlsx';             $objWrite->save($_savePath);               return $savePath.$fileName.'.xlsx';        }  }    function filterHtml($data){      return $data;      $data=strip_tags($data,'<img>');      return $data;  }  function dateof($data){      if($data&&is_numeric($data))return date('Y-m-d H:i:s',$data);      return $data;  }  function img($data){      $types = ['gif','jpeg','png','bmp','jpg'];      $pathinfo=pathinfo($data);      if(isset($pathinfo['extension'])&& in_array($pathinfo['extension'], $types)&& request()->isAjax())return '<img src='. root_path().'/'.$data.' width="80px"/>';      return $data;  }    function merge($key_arr1,$key_arr2){      $data_key_new=[];      foreach($key_arr1 as $k=>$v){          foreach ($key_arr2 as $key => $value) {              if($key<$k){                  $data_key_new[]=$value;                  unset($key_arr2[$key]);              }          }          $data_key_new[]=$v;      }      if($key_arr2){          foreach ($key_arr2 as $key => $value) {              $data_key_new[]=$value;              unset($key_arr2[$key]);          }      }      return $data_key_new;  }  function getip() {       if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], "unknown")) $ip = $_SERVER['REMOTE_ADDR'];       else if (getenv("REMOTE_ADDR") && strcasecmp(getenv("REMOTE_ADDR"), "unknown")) $ip = getenv("REMOTE_ADDR");       else if (getenv("HTTP_CLIENT_IP") && strcasecmp(getenv("HTTP_CLIENT_IP"), "unknown")) $ip = getenv("HTTP_CLIENT_IP");       else if (getenv("HTTP_X_FORWARDED_FOR") && strcasecmp(getenv("HTTP_X_FORWARDED_FOR"), "unknown")) $ip = getenv("HTTP_X_FORWARDED_FOR");       else $ip = "unknown";       return ($ip);   }   function safety(){      if(session("safety")!=false&&session("safety")!=sha1($_SERVER['HTTP_USER_AGENT']. getip()))exit(session(null).'登陆信息失效,请重新登陆!');      return true;  }    function imgHtml($data){      return '<img src="/'.level4($data).'" height="60" />';  }  function level0($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').$data;  }  function level1($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level1', $data);  }    function level2($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level2', $data);  }    function level3($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level3', $data);  }    function level4($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level4', $data);  }    function level5($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level5', $data);  }    function level6($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level6', $data);  }    function level7($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level7', $data);  }    function level8($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level8', $data);  }  function level9($data){      if(empty($data))return config('app.img_server').'/static/images/no_img.jpg';      if(is_numeric(strpos($data,'/'.'/')))return $data;      return config('app.img_server').str_replace('level0', 'level9', $data);  }  function money($data){      $data=number_format($data,2);      return str_replace(',', '', $data);  }  function orderId($suffix=false){      $ip=str_replace('.','',getip());     if(($s=9- strlen($ip))>0)$ip.=str_repeat (0, $s);      $ip=substr($ip, 0, 9);      $date = new DateTime();      $date=substr($date->format('ymdHisu'), 0, 14);      $order_id=$date.$ip;      if(!$suffix){          $order_id.=rand(100, 999);      }else{          $order_id.=$suffix;          if(($s=3- strlen($suffix))>0)$order_id.=str_repeat (0, $s);      }      return $order_id;  }  function mkdirs($path){      $path=str_replace('\\', '/', $path);      $exarr=explode('/',$path);      $mkpath=dirname($_SERVER['SCRIPT_FILENAME']).DIRECTORY_SEPARATOR;      foreach($exarr as $k=>$v){          $mkpath.=$v.DIRECTORY_SEPARATOR;          if(!is_dir($mkpath)&&$v)mkdir ($mkpath, 0777);      }  }    function RedEnvelope($fee,$c){      $n   = $fee/2;      for($i=0;$i<$c;$i++){          if($i==($c-1)){              $arr[]=$fee;          }else{              $arr[]=$j=rand(0.01,$n)+rand(11,99)/100;              $fee = $fee-$j;              $n = $fee/4;          }      }      return $arr;  }    function password_encode(string $str){      return password_hash(sha1(sha1(sha1($str))), PASSWORD_DEFAULT);  }    function str_length_cut(string $str,int $length){      if(mb_strlen($str)>$length)return mb_substr($str, 0, $length).'...';        return $str;  }  function region($json){      if($region=json_decode($json, true)){          if($allRegion=cache("allRegion")){              $str='';              foreach ($region as $value) {                  if($value&&$allRegion[$value])$str.=$allRegion[$value]['region_name'];              }              return $str;          }else{              lib\logistics\Region::allRegion();              region($json);          }      }      return $json;  }  function alipayRegion($data){      $data= json_decode($data, true);      $data=appModel('alipay', 'AlipayArea')->where(['areaCode'=>['in',array_values($data)]])->cache(300)->column('areaName','areaCode');      $str='';      foreach ($data as $key => $value) {          $str.=$value.' ';      }      return $str;  }  function display($data){      $c=new lib\base\BaseController;      return $c->display($data);  }    function filter_mark($text){       if(trim($text)=='')return '';       $text=preg_replace("/[[:punct:]\s]/",' ',$text);       $text=urlencode($text);       $text=preg_replace("/(%7E|%60|%21|%40|%23|%24|%25|%5E|%26|%27|%2A|%28|%29|%2B|%7C|%5C|%3D|\-|_|%5B|%5D|%7D|%7B|%3B|%22|%3A|%3F|%3E|%3C|%2C|\.|%2F|%A3%BF|%A1%B7|%A1%B6|%A1%A2|%A1%A3|%A3%AC|%7D|%A1%B0|%A3%BA|%A3%BB|%A1%AE|%A1%AF|%A1%B1|%A3%FC|%A3%BD|%A1%AA|%A3%A9|%A3%A8|%A1%AD|%A3%A4|%A1%A4|%A3%A1|%E3%80%82|%EF%BC%81|%EF%BC%8C|%EF%BC%9B|%EF%BC%9F|%EF%BC%9A|%E3%80%81|%E2%80%A6%E2%80%A6|%E2%80%9D|%E2%80%9C|%E2%80%98|%E2%80%99|%EF%BD%9E|%EF%BC%8E|%EF%BC%88)+/",' ',$text);       $text=urldecode($text);       return trim($text);    }       function isInWeixin(){       if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false ) {      return true;      }      return false;  }    function isInAlipay() {      if( strpos($_SERVER['HTTP_USER_AGENT'], 'AlipayClient') !== false ) {          return true;      }      return false;  }  function shopXianEnv($name){      $names=['root_path','app_path','config_path','route_path','runtime_path','extend_path'];      if(in_array($name, $names))return env ($name);      return null;  }    function mb_truncation($data,$length=30){      $suffix='';      if(mb_strlen($data)>$length)$suffix='...';      return mb_substr($data, 0, $length).$suffix;  }  function aimg($data){      return root_path().'/'.explode(',', $data)[0];  }  function root_path(){            $SCRIPT_NAME=explode('index.php', $_SERVER['SCRIPT_NAME']);            $ddd=count($SCRIPT_NAME)>1?$SCRIPT_NAME[0]:'';            return rtrim(request()->domain().$ddd,'/');        }